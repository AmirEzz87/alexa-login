<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Alexa Login</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { background:#000; color:#fff; font-family:sans-serif; display:flex; justify-content:center; align-items:center; min-height:100vh; margin:0; }
    .card { background:#111; padding:32px; border-radius:8px; width:100%; max-width:600px; box-sizing:border-box; }
    h1 { text-align:center; margin-top:0; margin-bottom:24px; }
    .field { margin-bottom:16px; }
    input { width:100%; padding:12px; font-size:16px; border-radius:4px; border:none; box-sizing:border-box; }
    button { width:100%; padding:14px; font-size:18px; font-weight:bold; border:none; border-radius:4px; background:#1dd65f; color:#000; cursor:pointer; }
    button:disabled { opacity:0.6; cursor:not-allowed; }
    .hidden { display:none; }
    .status { margin-bottom:16px; font-size:14px; color:#ccc; }
    .error { color:#ff6b6b; }
    .scopes { margin:12px 0; padding:12px; background:#181818; border-radius:4px; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="card">
    <h1>Alexa Login</h1>
    <div id="status" class="status"></div>

    <!-- LOGIN BLOCK -->
    <div id="login-block">
      <div class="field">
        <input id="email" type="email" placeholder="Email" autocomplete="email" />
      </div>
      <div class="field">
        <input id="password" type="password" placeholder="Password" autocomplete="current-password" />
      </div>
      <button id="login-btn">Sign In</button>
    </div>

    <!-- CONSENT BLOCK -->
    <div id="consent-block" class="hidden">
      <p id="consent-text"></p>
      <div id="scopes" class="scopes hidden"></div>
      <button id="approve-btn">Allow</button>
      <button id="deny-btn" style="margin-top:8px; background:#444; color:#fff;">Deny</button>
    </div>
  </div>

  <script>
    // TODO: put YOUR values here
    const SUPABASE_URL = "https://mvmvqycvorstsfcldzs.supabase.co";
    const SUPABASE_ANON_KEY = "YOUR_SUPABASE_ANON_KEY_HERE";

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const statusEl = document.getElementById("status");
    const loginBlock = document.getElementById("login-block");
    const consentBlock = document.getElementById("consent-block");
    const scopesEl = document.getElementById("scopes");
    const approveBtn = document.getElementById("approve-btn");
    const denyBtn = document.getElementById("deny-btn");
    const loginBtn = document.getElementById("login-btn");

    function setStatus(msg, isError = false) {
      statusEl.textContent = msg || "";
      statusEl.classList.toggle("error", isError);
    }

    function getAuthorizationId() {
      const params = new URLSearchParams(window.location.search);
      return params.get("authorization_id");
    }

    async function loadConsent(authId) {
      setStatus("Loading permissions...");
      const { data, error } = await supabase.auth.oauth.getAuthorizationDetails(authId);

      if (error || !data) {
        console.error("getAuthorizationDetails error:", error);
        setStatus("Invalid or expired authorization request.", true);
        return;
      }

      // hide login, show consent
      loginBlock.classList.add("hidden");
      consentBlock.classList.remove("hidden");

      const clientName = data.client?.name || "your Alexa integration";
      document.getElementById("consent-text").textContent =
        `Allow ${clientName} to access your account?`;

      if (data.scopes && data.scopes.length > 0) {
        scopesEl.classList.remove("hidden");
        scopesEl.innerHTML = "<strong>Requested permissions:</strong><br>" +
          data.scopes.map(s => `• ${s}`).join("<br>");
      } else {
        scopesEl.classList.add("hidden");
      }

      setStatus("");
      approveBtn.onclick = () => handleDecision(authId, true);
      denyBtn.onclick = () => handleDecision(authId, false);
    }

    async function handleDecision(authId, approve) {
      setStatus(approve ? "Authorizing..." : "Denying...");
      approveBtn.disabled = true;
      denyBtn.disabled = true;

      const fn = approve
        ? supabase.auth.oauth.approveAuthorization
        : supabase.auth.oauth.denyAuthorization;

      const { data, error } = await fn(authId);

      if (error || !data?.redirect_to) {
        console.error("decision error:", error);
        setStatus("Failed to complete authorization.", true);
        approveBtn.disabled = false;
        denyBtn.disabled = false;
        return;
      }

      window.location.href = data.redirect_to;
    }

    async function ensureLoggedIn(authId) {
      const { data } = await supabase.auth.getUser();
      if (data?.user) {
        // already logged in
        loginBlock.classList.add("hidden");
        await loadConsent(authId);
        return;
      }

      // not logged in → show login form
      loginBlock.classList.remove("hidden");
      consentBlock.classList.add("hidden");
      setStatus("Sign in to link your Alexa account.");

      loginBtn.onclick = async () => {
        const email = document.getElementById("email").value.trim();
        const password = document.getElementById("password").value;

        if (!email || !password) {
          setStatus("Email and password are required.", true);
          return;
        }

        loginBtn.disabled = true;
        setStatus("Signing in...");
        const { error } = await supabase.auth.signInWithPassword({ email, password });
        loginBtn.disabled = false;

        if (error) {
          console.error("signIn error:", error);
          setStatus("Invalid email or password.", true);
          return;
        }

        await loadConsent(authId);
      };
    }

    (async () => {
      const authId = getAuthorizationId();
      if (!authId) {
        setStatus("Missing authorization_id.", true);
        return;
      }
      await ensureLoggedIn(authId);
    })();
  </script>
</body>
</html>
